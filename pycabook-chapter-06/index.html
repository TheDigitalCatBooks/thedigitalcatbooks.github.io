<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>The Digital Cat Books - Chapter 6 - Integration with a real external system - Postgres</title>
    <meta charset="utf-8" />
    <meta http-equiv='content-language' content='en-gb'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="A blog featuring in-depth posts about Python, Scala, TDD, devops, security and all things development">
<meta name="description" content="Ooooh, I'm very sorry Hans. I didn't get that memo.Maybe you should've put it on the bulletin board.Die Hard, 1988The basic in-memory repository I implemented for the project is enough to show the concept of the repository layer abstraction. It is not enough to run a production …">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="Chapter 6 - Integration with a real external system - Postgres" />
<meta name="twitter:description" content="Ooooh, I'm very sorry Hans. I didn't get that memo.Maybe you should've put it on the bulletin board.Die Hard, 1988The basic in-memory repository I implemented for the project is enough to show the concept of the repository layer abstraction. It is not enough to run a production …" />
<meta name="twitter:image" content="https://www.thedigitalcatbooks.com/images/.jpg" />
    <script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400;1,600&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="/theme/css/main.min.css?acc8318d">
    <link href="/images/global/favicon.jpg" rel="icon">
    

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V9QBPJ9XS1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-V9QBPJ9XS1');
    </script>
  </head>

  <body class="preload">
    <div class="container">
      <div class="sidebar navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
  </ul>
</div></nav>

<section>
  <header>
    <h2>Pay what you want</h2>
  </header>
  <p>You can read the books and download the PDF versions for free. If you value my work and want to support me you can buy the PDF paying what you want. Thanks!</p>
  <article class="card">
    <a href="pycabook-introduction/">
      <img src="/images/pycabook/card.jpg" alt="pycabook/card" />
    </a>
    <div class="body">
      <h2>Clean Architectures in Python</h2>
      <div class="actions">
        <a class="action" href="https://leanpub.com/clean-architectures-in-python">Buy the book</a>
      </div>
    </div>
  </article>

</section>
<section>
  <header>
    <h2>Get in touch</h2>
  </header>
  <ul class="contact">
    <li><i class="fab fa-twitter" aria-hidden="true"></i> <a href="https://twitter.com/thedigicat">Twitter</a></li>
  </ul>
</section>      </div>
      <div class="page">
	<header class="primary" >
	  <button type="button">
	    <i class="fas fa-bars"></i>
	  </button>
	  <p>The Digital Cat Books</p>
	</header>
	<div class="mobile-menu navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
  </ul>
</div></nav>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/misc.html">misc</a></li>
</ul></section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
</ul></section>	</div>
	
<div class="page-content">
  <header>
    <p class="book-title">Clean Architectures in Python</p>
    <h1 class="section-title">Chapter 6 - Integration with a real external system - Postgres</h1>
  </header>
  
  <div class="post-content">
    <blockquote><p>Ooooh, I'm very sorry Hans. I didn't get that memo.</p><p>Maybe you should've put it on the bulletin board.</p><cite>Die Hard, 1988</cite></blockquote><p>The basic in-memory repository I implemented for the project is enough to show the concept of the repository layer abstraction. It is not enough to run a production system, though, so we need to implement a connection with a real storage like a database. Whenever we use an external system and we want to test the interface we can use mocks, but at a certain point we need to ensure that the two systems actually work together, and this is when we need to start creating integration tests.</p><p>In this chapter I will show how to set up and run integration tests between our application and a real database. At the end of the chapter I will have a repository that allows the application to interface with PostgreSQL, and a battery of tests that run using a real database instance running in Docker.</p><p>This chapter will show you one of the biggest advantages of a clean architecture, namely the simplicity with which you can replace existing components with others, possibly based on a completely different technology.</p><h2 id="decoupling-with-interfaces">Decoupling with interfaces<a class="headerlink" href="#decoupling-with-interfaces" title="Permanent link">¶</a></h2><p>The clean architecture we devised in the previous chapters defines a use case that receives a repository instance as an argument and uses its <code>list</code> method to retrieve the contained entries. This allows the use case to form a very loose coupling with the repository, being connected only through the API exposed by the object and not to the real implementation. In other words, the use cases are polymorphic with respect to the method <code>list</code>.</p><p>This is very important and it is the core of the clean architecture design. Being connected through an API, the use case and the repository can be replaced by different implementations at any time, given that the new implementation provides the requested interface.</p><p>It is worth noting, for example, that the initialisation of the object is not part of the API that the use cases are using since the repository is initialised in the main script and not in each use case. The method <code>__init__</code>, thus, doesn't need to be the same among the repository implementations, which gives us a great deal of flexibility, as different storage systems may need different initialisation values.</p><p>The simple repository we implemented in one of the previous chapters is</p><div class="code"><div class="title"><code>rentomatic/repository/memrepo.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rentomatic.domain.room</span> <span class="kn">import</span> <span class="n">Room</span>


<span class="k">class</span> <span class="nc">MemRepo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">Room</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="s2">&quot;code__eq&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;code__eq&quot;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="s2">&quot;price__eq&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;price__eq&quot;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;price__lt&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">price</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;price__lt&quot;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;price__gt&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">price</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="s2">&quot;price__gt&quot;</span><span class="p">])</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div></div><p>whose interface is made of two parts: the initialisation and the method <code>list</code>. The method <code>__init__</code> accepts values because this specific object doesn't act as long-term storage, so we are forced to pass some data every time we instantiate the class.</p><p>A repository based on a proper database will not need to be filled with data when initialised, its main job being that of storing data between sessions, but will nevertheless need to be initialised at least with the database address and access credentials.</p><p>Furthermore, we have to deal with a proper external system, so we have to devise a strategy to test it, as this might require a running database engine in the background. Remember that we are creating a specific implementation of a repository, so everything will be tailored to the actual database system that we will choose.</p><h2 id="a-repository-based-on-postgresql">A repository based on PostgreSQL<a class="headerlink" href="#a-repository-based-on-postgresql" title="Permanent link">¶</a></h2><p>Let's start with a repository based on a popular SQL database, <a href="https://www.postgresql.org">PostgreSQL</a>. It can be accessed from Python in many ways, but the best one is probably through the <a href="https://www.sqlalchemy.org">SQLAlchemy</a> interface. SQLAlchemy is an ORM, a package that maps objects (as in object-oriented) to a relational database. ORMs can normally be found in web frameworks like Django or in standalone packages like the one we are considering.</p><p>The important thing about ORMs is that they are very good examples of something you shouldn't try to mock. Properly mocking the SQLAlchemy structures that are used when querying the DB results in very complex code that is difficult to write and almost impossible to maintain, as every single change in the queries results in a series of mocks that have to be written again<sup>[<a id="fr--3442302" href="#fd--3442302">1</a>]</sup>.</p><p>We need therefore to set up an integration test. The idea is to create the DB, set up the connection with SQLAlchemy, test the condition we need to check, and destroy the database. Since the action of creating and destroying the DB can be expensive in terms of time, we might want to do it just at the beginning and at the end of the whole test suite, but even with this change, the tests will be slow. This is why we will also need to use labels to avoid running them every time we run the suite. Let's face this complex task one step at a time.</p><h2 id="label-integration-tests">Label integration tests<a class="headerlink" href="#label-integration-tests" title="Permanent link">¶</a></h2><p>The first thing we need to do is to label integration tests, exclude them by default and create a way to run them. Since pytest supports labels, called <em>marks</em>, we can use this feature to add a global mark to a whole module. Create the file <code>tests/repository/postgres/test_postgresrepo.py</code> and put in it this code</p><div class="code"><div class="title"><code>tests/repository/postgres/test_postgresrepo.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>


<span class="k">def</span> <span class="nf">test_dummy</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div></div><p>The module attribute <code>pytestmark</code> labels every test in the module with the tag <code>integration</code>. To verify that this works I added a <code>test_dummy</code> test function which always passes.</p><p>The marker should be registered in <code>pytest.ini</code></p><div class="code"><div class="title"><code>pytest.ini</code></div><div class="content"><div class="highlight"><pre><span></span><span class="k">[pytest]</span>
<span class="na">minversion</span> <span class="o">=</span> <span class="s">2.0</span>
<span class="na">norecursedirs</span> <span class="o">=</span> <span class="s">.git .tox requirements*</span>
<span class="na">python_files</span> <span class="o">=</span> <span class="s">test*.py</span>
<span class="na">markers</span> <span class="o">=</span>
        <span class="na">integration: integration tests</span>
</pre></div>
</div></div><p>You can now run <code>pytest -svv -m integration</code> to ask pytest to run only the tests marked with that label. The option <code>-m</code> supports a rich syntax that you can learn by reading the <a href="https://docs.pytest.org/en/latest/example/markers.html">documentation</a>.</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>$ pytest -svv -m integration
========================= test session starts ===========================
platform linux -- Python XXXX, pytest-XXXX, py-XXXX, pluggy-XXXX --
cabook/venv3/bin/python3
cachedir: .cache
rootdir: cabook/code/calc, inifile: pytest.ini
plugins: cov-XXXX
collected 36 items / 35 deselected / 1 selected

tests/repository/postgres/test_postgresrepo.py::test_dummy PASSED

=================== 1 passed, 35 deselected in 0.20s ====================
</pre></div>
</div></div><p>While this is enough to run integration tests selectively, it is not enough to skip them by default. To do this, we can alter the pytest setup to label all those tests as skipped, but this will give us no means to run them. The standard way to implement this is to define a new command-line option and to process each marked test according to the value of this option.</p><p>To do it open the file <code>tests/conftest.py</code> that we already created and add the following code</p><div class="code"><div class="title"><code>tests/conftest.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pytest_addoption</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">addoption</span><span class="p">(</span>
        <span class="s2">&quot;--integration&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;run integration tests&quot;</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">pytest_runtest_setup</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;integration&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keywords</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span>
        <span class="s2">&quot;integration&quot;</span>
    <span class="p">):</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;need --integration option to run&quot;</span><span class="p">)</span>
</pre></div>
</div></div><p>The first function is a hook into the pytest CLI parser that adds the option <code>--integration</code>. When this option is specified on the command line the pytest setup will contain the key <code>integration</code> with value <code>True</code>.</p><p>The second function is a hook into the pytest setup of every single test. The variable <code>item</code> contains the test itself (actually a <code>_pytest.python.Function</code> object), which in turn contains two useful pieces of information. The first is the attribute <code>item.keywords</code>, that contains the test marks, alongside many other interesting things like the name of the test, the file, the module, and also information about the patches that happen inside the test. The second is the attribute <code>item.config</code> that contains the parsed pytest command line.</p><p>So, if the test is marked with <code>integration</code> (<code>'integration' in item.keywords</code>) and the option <code>--integration</code> is not present (<code>not item.config.getvalue("integration")</code>) the test is skipped.</p><p>This is the output with <code>--integration</code></p><div class="code"><div class="content"><div class="highlight"><pre><span></span>$ pytest -svv --integration
========================= test session starts ===========================
platform linux -- Python XXXX, pytest-XXXX, py-XXXX, pluggy-XXXX --
cabook/venv3/bin/python3
cachedir: .cache
rootdir: cabook/code/calc, inifile: pytest.ini
plugins: cov-XXXX
collected 36 items

...
tests/repository/postgres/test_postgresrepo.py::test_dummy PASSED
...

========================= 36 passed in 0.26s ============================
</pre></div>
</div></div><p>and this is the output without the custom option</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>$ pytest -svv 
========================= test session starts ===========================
platform linux -- Python XXXX, pytest-XXXX, py-XXXX, pluggy-XXXX --
cabook/venv3/bin/python3
cachedir: .cache
rootdir: cabook/code/calc, inifile: pytest.ini
plugins: cov-XXXX
collected 36 items

...
tests/repository/postgres/test_postgresrepo.py::test_dummy SKIPPED
...

=================== 35 passed, 1 skipped in 0.27s =======================
</pre></div>
</div></div><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c06-s01">https://github.com/pycabook/rentomatic/tree/ed2-c06-s01</a></p></div></div></div><h2 id="create-sqlalchemy-classes">Create SQLAlchemy classes<a class="headerlink" href="#create-sqlalchemy-classes" title="Permanent link">¶</a></h2><p>Creating and populating the test database with initial data will be part of the test suite, but we need to define somewhere the tables that will be contained in the database. This is where SQLAlchemy's ORM comes into play, as we will define those tables in terms of Python objects.</p><p>Add the packages <code>SQLAlchemy</code> and <code>psycopg2</code> to the requirements file <code>prod.txt</code></p><div class="code"><div class="title"><code>requirements/prod.txt</code></div><div class="content"><div class="highlight"><pre><span></span>Flask
SQLAlchemy
psycopg2
</pre></div>
</div></div><p>and update the installed packages with</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>$ pip install -r requirements/dev.txt
</pre></div>
</div></div><p>Create the file <code>rentomatic/repository/postgres_objects.py</code> with the following content</p><div class="code"><div class="title"><code>rentomatic/repository/postgres_objects.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">Room</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;room&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">36</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
</pre></div>
</div></div><p>Let's comment it section by section</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Float</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
</pre></div>
</div></div><p>We need to import many things from the SQLAlchemy package to set up the database and to create the table. Remember that SQLAlchemy has a declarative approach, so we need to instantiate the object <code>Base</code> and then use it as a starting point to declare the tables/objects.</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Room</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;room&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">36</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Float</span><span class="p">)</span>
</pre></div>
</div></div><p>This is the class that represents the room in the database. It is important to understand that this is not the class we are using in the business logic, but the class that defines the table in the SQL database that we will use to map the <code>Room</code> entity. The structure of this class is thus dictated by the needs of the storage layer, and not by the use cases. You might want for instance to store <code>longitude</code> and <code>latitude</code> in a JSON field, to allow for easier extendibility, without changing the definition of the domain model. In the simple case of the Rent-o-matic project, the two classes almost overlap, but this is not the case generally speaking.</p><p>Obviously, this means that you have to keep the storage and the domain levels in sync and that you need to manage migrations on your own. You can use tools like Alembic, but the migrations will not come directly from domain model changes.</p><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c06-s02">https://github.com/pycabook/rentomatic/tree/ed2-c06-s02</a></p></div></div></div><h2 id="orchestration-management">Orchestration management<a class="headerlink" href="#orchestration-management" title="Permanent link">¶</a></h2><p>When we run the integration tests the Postgres database engine must be already running in the background, and it must be already configured, for example, with a pristine database ready to be used. Moreover, when all the tests have been executed the database should be removed and the database engine stopped.</p><p>This is a perfect job for Docker, which can run complex systems in isolation with minimal configuration. We have a choice here: we might want to orchestrate the creation and destruction of the database with an external script or try to implement everything in the test suite. The first solution is what many frameworks use, and what I explored in my series of posts  <a href="https://www.thedigitalcatonline.com/blog/2020/07/05/flask-project-setup-tdd-docker-postgres-and-more-part-1/">Flask Project Setup: TDD, Docker, Postgres and more</a>, so in this chapter I will show an implementation of that solution.</p><p>As I explained in the posts I mentioned the plan is to create a management script that spins up and tears down the required containers, runs the tests in between. The management script can be used also to run the application itself, or to create development setups, but in this case I will simplify it to manage only the tests. I highly recommend that you read those posts if you want to get the big picture behind the setup I will use.</p><p>The first thing we have to do if we plan to use Docker Compose is to add the requirement to <code>requirements/test.txt</code></p><div class="code"><div class="title"><code>requirements/test.txt</code></div><div class="content"><div class="highlight"><pre><span></span>-r prod.txt
tox
coverage
pytest
pytest-cov
pytest-flask
docker-compose
</pre></div>
</div></div><p>and install it running <code>pip install -r requirements/dev.txt</code>. The management script is the following</p><div class="code"><div class="title"><code>manage.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span>


<span class="c1"># Ensure an environment variable exists and has a value</span>
<span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="n">APPLICATION_CONFIG_PATH</span> <span class="o">=</span> <span class="s2">&quot;config&quot;</span>
<span class="n">DOCKER_PATH</span> <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>


<span class="k">def</span> <span class="nf">app_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">APPLICATION_CONFIG_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">docker_compose_file</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DOCKER_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">.yml&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_json_configuration</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="c1"># Read configuration from the relative JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">app_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Convert the config into a usable Python dictionary</span>
    <span class="n">config_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config_data</span>


<span class="k">def</span> <span class="nf">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">configuration</span> <span class="o">=</span> <span class="n">read_json_configuration</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">setenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>


<span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">docker_compose_cmdline</span><span class="p">(</span><span class="n">commands_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">)</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">compose_file</span> <span class="o">=</span> <span class="n">docker_compose_file</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">compose_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">compose_file</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

    <span class="n">command_line</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="n">compose_file</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">commands_string</span><span class="p">:</span>
        <span class="n">command_line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">commands_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">command_line</span>


<span class="k">def</span> <span class="nf">run_sql</span><span class="p">(</span><span class="n">statements</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">dbname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">),</span>
        <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">),</span>
        <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">),</span>
        <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">wait_for_logs</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">message</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>


<span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;testing&quot;</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;up -d&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;logs postgres&quot;</span><span class="p">)</span>
    <span class="n">wait_for_logs</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="s2">&quot;ready to accept connections&quot;</span><span class="p">)</span>

    <span class="n">run_sql</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;CREATE DATABASE </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;APPLICATION_DB&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;pytest&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-svv&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--cov=application&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--cov-report=term-missing&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">cmdline</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</pre></div>
</div></div><p>Let's see what it does block by block.</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="ch">#! /usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">psycopg2.extensions</span> <span class="kn">import</span> <span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span>


<span class="c1"># Ensure an environment variable exists and has a value</span>
<span class="k">def</span> <span class="nf">setenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>


<span class="n">APPLICATION_CONFIG_PATH</span> <span class="o">=</span> <span class="s2">&quot;config&quot;</span>
<span class="n">DOCKER_PATH</span> <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</pre></div>
</div></div><p>Some Docker containers (like the PostgreSQL one that we will use shortly) depend on environment variables to perform the initial setup, so we need to define a function to set environment variables if they are not already initialised. We also define a couple of paths for configuration files.</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">app_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">APPLICATION_CONFIG_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">docker_compose_file</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DOCKER_PATH</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="si">}</span><span class="s2">.yml&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">read_json_configuration</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="c1"># Read configuration from the relative JSON file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">app_config_file</span><span class="p">(</span><span class="n">config</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">config_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Convert the config into a usable Python dictionary</span>
    <span class="n">config_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">config_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config_data</span>


<span class="k">def</span> <span class="nf">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="n">configuration</span> <span class="o">=</span> <span class="n">read_json_configuration</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">configuration</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">setenv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div></div><p>As in principle I expect to have a different configuration at least for development, testing, and production, I introduced <code>app_config_file</code> and <code>docker_compose_file</code> that return the specific file for the environment we are working in. The function <code>read_json_configuration</code> has been isolated from <code>configure_app</code> as it will be imported by the tests to initialise the database repository.</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="nd">@click</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">cli</span><span class="p">():</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">docker_compose_cmdline</span><span class="p">(</span><span class="n">commands_string</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">)</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">compose_file</span> <span class="o">=</span> <span class="n">docker_compose_file</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">compose_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="n">compose_file</span><span class="si">}</span><span class="s2"> does not exist&quot;</span><span class="p">)</span>

    <span class="n">command_line</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;docker-compose&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="n">compose_file</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">commands_string</span><span class="p">:</span>
        <span class="n">command_line</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">commands_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">command_line</span>
</pre></div>
</div></div><p>This is a simple function that creates the Docker Compose command line that avoids repeating long lists of options whenever we need to orchestrate the containers.</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_sql</span><span class="p">(</span><span class="n">statements</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">dbname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">),</span>
        <span class="n">user</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">),</span>
        <span class="n">password</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">),</span>
        <span class="n">host</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">),</span>
        <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">set_isolation_level</span><span class="p">(</span><span class="n">ISOLATION_LEVEL_AUTOCOMMIT</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">statements</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">wait_for_logs</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">message</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">logs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>
</pre></div>
</div></div><p>The function <code>run_sql</code> allows us to run SQL commands on a running Postgres database, and will come in handy when we will create the empty test database. The second function, <code>wait_for_logs</code> is a simple way to monitor the Postgres container and to be sure it's ready to be used. Whenever you spin up containers programmatically you need to be aware that they have a certain startup time before they are ready, and act accordingly.</p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="nd">@cli</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">argument</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;testing&quot;</span>
    <span class="n">configure_app</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;APPLICATION_CONFIG&quot;</span><span class="p">))</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;up -d&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;logs postgres&quot;</span><span class="p">)</span>
    <span class="n">wait_for_logs</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="s2">&quot;ready to accept connections&quot;</span><span class="p">)</span>

    <span class="n">run_sql</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;CREATE DATABASE </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;APPLICATION_DB&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;pytest&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-svv&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--cov=application&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--cov-report=term-missing&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">cmdline</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>

    <span class="n">cmdline</span> <span class="o">=</span> <span class="n">docker_compose_cmdline</span><span class="p">(</span><span class="s2">&quot;down&quot;</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmdline</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cli</span><span class="p">()</span>
</pre></div>
</div></div><p>This function is the last that we define, and the only command provided by our management script. First of all the application is configured with the name <code>testing</code>, which means that we will use the configuration file <code>config/testing.json</code> and the Docker Compose file <code>docker/testing.yml</code>. All these names and paths are just conventions that comes from the arbitrary setup of this management script, so you are clearly free to structure your project in a different way.</p><p>The function then spins up the containers according to the Docker Compose file, running <code>docker-compose up -d</code>. It waits for the log message that communicates the database is ready to accept connections and runs the SQL command that creates the testing database.</p><p>After this it runs Pytest with a default set of options, adding all the options that we will provide on the command line, and eventually tears down the Docker Compose containers.</p><p>To complete the setup we need to define a configuration file for Docker Compose</p><div class="code"><div class="title"><code>docker/testing.yml</code></div><div class="content"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">postgres</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">POSTGRES_DB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_DB}</span>
      <span class="nt">POSTGRES_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_USER}</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PASSWORD}</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;${POSTGRES_PORT}:5432&quot;</span>
</pre></div>
</div></div><p>And finally a JSON configuration file</p><div class="code"><div class="title"><code>config/testing.json</code></div><div class="content"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_ENV&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_CONFIG&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;testing&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;5433&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div></div><p>A couple of notes about this configuration. First of all it defines both <code>FLASK_ENV</code> and <code>FLASK_CONFIG</code>. The first is, as you might remember, and internal Flask variable that can only be <code>development</code> or <code>production</code>, and is connected with the internal debugger. The second is the variable that we use to configure our Flask application with the objects in <code>application/config.py</code>. For testing purposes we set <code>FLASK_ENV</code> to <code>production</code> as we don't need the internal debugger, and <code>FLASK_CONFIG</code> to <code>testing</code>, which will resul in the application being configured with the class <code>TestingConfig</code>. This class sets the internal Flask parameter <code>TESTING</code> to <code>True</code>.</p><p>The rest of the JSON configuration initialises variables whose names start with the prefix <code>POSTGRES_</code>. These are variables required by the Postgres Docker container. When the container is run, it automatically creates a database with the name specified by <code>POSTGRES_DB</code>. It also creates a user with a password, using the values specified in <code>POSTGRES_USER</code> and <code>POSTGRES_PASSWORD</code>.</p><p>Last, I introduced the variable <code>APPLICATION_DB</code> because I want to create a specific database which is not the one the default one. The default port <code>POSTGRES_PORT</code> has been changed from the standard value 5432 to 5433 to avoid clashing with any database already running on the machine (either natively or containerised). As you can see in the Docker Compose configuration file this changes only the external mapping of the container and not the actual port the database engine is using inside the container.</p><p>With all these files in place we are ready to start designing our tests.</p><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c06-s03">https://github.com/pycabook/rentomatic/tree/ed2-c06-s03</a></p></div></div></div><h2 id="database-fixtures">Database fixtures<a class="headerlink" href="#database-fixtures" title="Permanent link">¶</a></h2><p>As we defined the configuration of the database in a JSON file we need a fixture that loads that same configuration, so that we can connect to the database during the tests. As we already have the function <code>read_json_configuration</code> in the management script we just need to wrap that. This is a fixture that is not specific to the Postgres repository, so I will introduce it in <code>tests/conftest.py</code></p><div class="code"><div class="title"><code>tests/conftest.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">manage</span> <span class="kn">import</span> <span class="n">read_json_configuration</span>

<span class="o">...</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">app_configuration</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">read_json_configuration</span><span class="p">(</span><span class="s2">&quot;testing&quot;</span><span class="p">)</span>
</pre></div>
</div></div><p>As you can see I hardcoded the name of the configuration file for simplicity's sake. Another solution might be to create an environment variable with the application configuration in the management script and to read it from here.</p><p>The rest of the fixtures contains code that is specific to Postgres, so it is better to keep the code separated in a more specific file <code>conftest.py</code></p><div class="code"><div class="title"><code>tests/repository/postgres/conftest.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">rentomatic.repository.postgres_objects</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">Room</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pg_session_empty</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">):</span>
    <span class="n">conn_str</span> <span class="o">=</span> <span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">],</span>
        <span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">],</span>
        <span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">],</span>
        <span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">],</span>
        <span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">conn_str</span><span class="p">)</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">engine</span>

    <span class="n">DBSession</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">session</span>

    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pg_test_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;f853578c-fc0f-4e65-81b8-566c5dffa35a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">215</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.75436293</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">405</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.18228006</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.74640997</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.27891577</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.45994069</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;eed76e77-55c1-41ce-985d-ca49bf6c0585&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">93</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.33894476</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.39916678</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pg_session</span><span class="p">(</span><span class="n">pg_session_empty</span><span class="p">,</span> <span class="n">pg_test_data</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pg_test_data</span><span class="p">:</span>
        <span class="n">new_room</span> <span class="o">=</span> <span class="n">Room</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
            <span class="n">size</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
            <span class="n">price</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span>
            <span class="n">longitude</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span>
            <span class="n">latitude</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">pg_session_empty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_room</span><span class="p">)</span>
        <span class="n">pg_session_empty</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">pg_session_empty</span>

    <span class="n">pg_session_empty</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Room</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div></div><p>The first fixture <code>pg_session_empty</code> creates a session to the empty initial database, while <code>pg_test_data</code> defines the values that we will load into the database. As we are not mutating this set of values we don't need to create a fixture, but this is the easier way to make it available both to the other fixtures and to the tests. The last fixture <code>pg_session</code> fills the database with Postgres objects created with the test data. Pay attention that these are not entities, but the Postgres objects we created to map them.</p><p>Note that this last fixture has a <code>function</code> scope, thus it is run for every test. Therefore, we delete all rooms after the yield returns, leaving the database exactly as it was before the test. Generally speaking you should always clean up after tests. The endpoint we are testing does not write to the database so in this specific case there is no real need to clean up, but I prefer to implement a complete solution from step zero.</p><p>We can test this whole setup changing the function <code>test_dummy</code> so that it fetches all the rows of the table <code>Room</code> and verifying that the query returns 4 values.</p><p>The new version of <code>tests/repository/postgres/test_postgresrepo.py</code> is </p><div class="code"><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">rentomatic.repository.postgres_objects</span> <span class="kn">import</span> <span class="n">Room</span>

<span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>


<span class="k">def</span> <span class="nf">test_dummy</span><span class="p">(</span><span class="n">pg_session</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">pg_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Room</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="o">==</span> <span class="mi">4</span>
</pre></div>
</div></div><p>At this point you can run the test suite with integration tests. You should notice a clear delay when pytest executes the function <code>test_dummy</code> as Docker will take some time to spin up the database container and prepare the data</p><div class="code"><div class="content"><div class="highlight"><pre><span></span>$ ./manage.py test -- --integration
========================= test session starts ===========================
platform linux -- Python XXXX, pytest-XXXX, py-XXXX, pluggy-XXXX --
cabook/venv3/bin/python3
cachedir: .cache
rootdir: cabook/code/calc, inifile: pytest.ini
plugins: cov-XXXX
collected 36 items

...
tests/repository/postgres/test_postgresrepo.py::test_dummy PASSED
...

========================= 36 passed in 0.26s ============================
</pre></div>
</div></div><p>Note that to pass the option <code>--integration</code> we need to use <code>--</code> otherwise Click would consider the option as belonging to the script <code>./manage.py</code> instead of passing it as a pytest argument.</p><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c06-s04">https://github.com/pycabook/rentomatic/tree/ed2-c06-s04</a></p></div></div></div><h2 id="integration-tests">Integration tests<a class="headerlink" href="#integration-tests" title="Permanent link">¶</a></h2><p>At this point we can create the real tests in the file <code>test_postgresrepo.py</code>, replacing the function <code>test_dummy</code>. All test receive the fixtures <code>app_configuration</code>, <code>pg_session</code>, and <code>pg_test_data</code>. The first fixture allows us to initialise the class <code>PostgresRepo</code> using the proper parameters. The second creates the database using the test data that is then contained in the third fixture.</p><p>The tests for this repository are basically a copy of the ones created for <code>MemRepo</code>, which is not surprising. Usually, you want to test the very same conditions, whatever the storage system. Towards the end of the chapter we will see, however, that while these files are initially the same, they can evolve differently as we find bugs or corner cases that come from the specific implementation (in-memory storage, PostgreSQL, and so on).</p><div class="code"><div class="title"><code>tests/repository/postgres/test_postgresrepo.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">rentomatic.repository</span> <span class="kn">import</span> <span class="n">postgresrepo</span>

<span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>


<span class="k">def</span> <span class="nf">test_repository_list_without_parameters</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">pg_session</span><span class="p">,</span> <span class="n">pg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">postgresrepo</span><span class="o">.</span><span class="n">PostgresRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">repo_rooms</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pg_test_data</span><span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_code_equal_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">pg_session</span><span class="p">,</span> <span class="n">pg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">postgresrepo</span><span class="o">.</span><span class="n">PostgresRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;code__eq&quot;</span><span class="p">:</span> <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">repo_rooms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_equal_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">pg_session</span><span class="p">,</span> <span class="n">pg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">postgresrepo</span><span class="o">.</span><span class="n">PostgresRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__eq&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">repo_rooms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_less_than_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">pg_session</span><span class="p">,</span> <span class="n">pg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">postgresrepo</span><span class="o">.</span><span class="n">PostgresRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__lt&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">repo_rooms</span><span class="p">])</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;f853578c-fc0f-4e65-81b8-566c5dffa35a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eed76e77-55c1-41ce-985d-ca49bf6c0585&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_greater_than_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">pg_session</span><span class="p">,</span> <span class="n">pg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">postgresrepo</span><span class="o">.</span><span class="n">PostgresRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__gt&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">repo_rooms</span><span class="p">])</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_between_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">pg_session</span><span class="p">,</span> <span class="n">pg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">postgresrepo</span><span class="o">.</span><span class="n">PostgresRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__lt&quot;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span> <span class="s2">&quot;price__gt&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">repo_rooms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span>
</pre></div>
</div></div><p>Remember that I introduced these tests one at a time and that I'm not showing you the full TDD workflow only for brevity's sake. The code of the class <code>PostgresRepo</code> has been developed following a strict TDD approach, and I recommend you to do the same. The resulting code goes in <code>rentomatic/repository/postgresrepo.py</code>, the same directory where we created the file <code>postgres_objects.py</code>.</p><div class="code"><div class="title"><code>rentomatic/repository/postgresrepo.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="kn">from</span> <span class="nn">rentomatic.domain</span> <span class="kn">import</span> <span class="n">room</span>
<span class="kn">from</span> <span class="nn">rentomatic.repository.postgres_objects</span> <span class="kn">import</span> <span class="n">Base</span><span class="p">,</span> <span class="n">Room</span>


<span class="k">class</span> <span class="nc">PostgresRepo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="n">connection_string</span> <span class="o">=</span> <span class="s2">&quot;postgresql+psycopg2://</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">@</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">],</span>
            <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">],</span>
            <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">],</span>
            <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">],</span>
            <span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">connection_string</span><span class="p">)</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span>

    <span class="k">def</span> <span class="nf">_create_room_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">room</span><span class="o">.</span><span class="n">Room</span><span class="p">(</span>
                <span class="n">code</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">code</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                <span class="n">price</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">price</span><span class="p">,</span>
                <span class="n">latitude</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span>
                <span class="n">longitude</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">results</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">DBSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Room</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_room_objects</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="k">if</span> <span class="s2">&quot;code__eq&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Room</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;code__eq&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;price__eq&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Room</span><span class="o">.</span><span class="n">price</span> <span class="o">==</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;price__eq&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;price__lt&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Room</span><span class="o">.</span><span class="n">price</span> <span class="o">&lt;</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;price__lt&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;price__gt&quot;</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Room</span><span class="o">.</span><span class="n">price</span> <span class="o">&gt;</span> <span class="n">filters</span><span class="p">[</span><span class="s2">&quot;price__gt&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_room_objects</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>
</div></div><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c06-s05">https://github.com/pycabook/rentomatic/tree/ed2-c06-s05</a></p></div></div></div><p>You might notice that <code>PostgresRepo</code> is very similar to <code>MemRepo</code>. This is the case because the case we are dealing with here, the list of <code>Room</code> objects, is pretty simple, so I don't expect great differences between an in-memory database an a production-ready relational one. As the use cases get more complex you will need to start leveraging the features provided by the engine that you are using, and methods such as <code>list</code> might evolve to become very different.</p><p>Note that the method <code>list</code> returns domain models, which is allowed as the repository is implemented in one of the outer layers of the architecture.</p><hr><p>As you can see, while setting up a proper integration testing environment is not trivial, the changes that our architecture required to work with a real repository are very limited. I think this is a good demonstration of the flexibility of a layered approach such as the one at the core of the clean architecture.</p><p>Since this chapter mixed the setup of the integration testing with the introduction of a new repository, I will dedicate the next chapter purely to introduce a repository based on MongoDB, using the same structure that I created in this chapter. Supporting multiple databases (in this case even relational and non-relational) is not an uncommon pattern, as it allows you to use the approach that best suits each use case.</p><div id="_footnotes"><div class="footnote" id="fd--3442302"><a href="#fr--3442302">1</a><p>Unless you consider things like <code>sessionmaker_mock()().query.assert_called_with(Room)</code> something attractive. And this was by far the simplest mock I had to write.</p></div></div>
  </div>

  <footer>
    <div class="prevnext">
      <div class="prevnext-prev">
	<p class="prevnext-label">Previous</p>
	<p>
	  <a href="/pycabook-chapter-05/">Chapter 5 - Error management</a>
	</p>
      </div>

      <div class="prevnext-next">
	<p class="prevnext-label">Next</p>
	<p>
	  <a href="/pycabook-chapter-07/">Chapter 7 - Integration with a real external system - MongoDB</a>
	</p>
      </div>
    </div>

    <div class="post-info">
      <p>Last update: <time datetime="2021-08-20T16:00:00+01:00"> 20/08/2021</time></p>
      <p class="tags">
      </p>
      <p class="share">Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=Chapter%206%20-%20Integration%20with%20a%20real%20external%20system%20-%20Postgres&url=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-06/&via=thedigicat" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-06/&title=Chapter%206%20-%20Integration%20with%20a%20real%20external%20system%20-%20Postgres&summary=Ooooh%2C%20I%27m%20very%20sorry%20Hans.%20I%20didn%27t%20get%20that%20memo.Maybe%20you%20should%27ve%20put%20it%20on%20the%20bulletin%20board.Die%20Hard%2C%201988The%20basic%20in-memory%20repository%20I%20implemented%20for%20the%20project%20is%20enough%20to%20show%20the%20concept%20of%20the%20repository%20layer%20abstraction.%20It%20is%20not%20enough%20to%20run%20a%20production%20%E2%80%A6&source=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-06/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=Chapter%206%20-%20Integration%20with%20a%20real%20external%20system%20-%20Postgres&u=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-06/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=Chapter%206%20-%20Integration%20with%20a%20real%20external%20system%20-%20Postgres&amp;body=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-06/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-06/&title=Chapter%206%20-%20Integration%20with%20a%20real%20external%20system%20-%20Postgres" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span></p>    
    </div>
  </footer>
  
  <section class="links">
    <header>
      <h2>Section 8 of Clean Architectures in Python</h2>
    </header>
    <div>
      <h3>Previous</h3>
      <ul>
        <li><a href="/pycabook-introduction/">Introduction</a></li>
        <li><a href="/pycabook-about-the-book/">About the book</a></li>
        <li><a href="/pycabook-chapter-01/">Chapter 1 - A day in the life of a clean system</a></li>
        <li><a href="/pycabook-chapter-02/">Chapter 2 - Components of a clean architecture</a></li>
        <li><a href="/pycabook-chapter-03/">Chapter 3 - A basic example</a></li>
        <li><a href="/pycabook-chapter-04/">Chapter 4 - Add a web application</a></li>
        <li><a href="/pycabook-chapter-05/">Chapter 5 - Error management</a></li>
      </ul>
      
      <h3>Next</h3>
      <ul>
        <li><a href="/pycabook-chapter-07/">Chapter 7 - Integration with a real external system - MongoDB</a></li>
        <li><a href="/pycabook-chapter-08/">Chapter 8 - Run a production-ready system</a></li>
        <li><a href="/pycabook-changelog/">Changelog</a></li>
        <li><a href="/pycabook-colophon/">Colophon</a></li>
      </ul>
    </div>
  </section>

  
</div>

      </div>
    </div>
    <script src="/theme/js/packed.js?46a8f903"></script>

  </body>
</html>