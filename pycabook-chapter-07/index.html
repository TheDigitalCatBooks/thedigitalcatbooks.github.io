<!DOCTYPE HTML>
<html lang="en">
  <head>
    <title>Clean Architectures in Python - Chapter 7 - Integration with a real external system - MongoDB</title>
    <meta charset="utf-8" />
    <meta http-equiv='content-language' content='en-gb'>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <meta name="description" content="A website that hosts free books about computer science">
<meta name="description" content="Chapter 7 - Integration with a real external system - MongoDB">
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@thedigicat" />
<meta name="twitter:title" content="Chapter 7 - Integration with a real external system - MongoDB" />
<meta name="twitter:description" content="Read the full article on The Digital Cat Books" />
<meta name="twitter:image" content="https://www.thedigitalcatbooks.com/images/.jpg" />
    <script src="https://kit.fontawesome.com/15214b60ba.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,600;1,400;1,600&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet"> 
    <link rel="stylesheet" href="/theme/css/main.min.css?2d24403f">
    <link href="/images/global/favicon.jpg" rel="icon">
    

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V9QBPJ9XS1"></script>
    <script>
     window.dataLayer = window.dataLayer || [];
     function gtag(){dataLayer.push(arguments);}
     gtag('js', new Date());

     gtag('config', 'G-V9QBPJ9XS1');
    </script>
  </head>

  <body class="preload">
    <div class="container">
      <div class="sidebar navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
  </ul>
</div></nav>

<section>
  <header>
    <h2>Pay what you want</h2>
  </header>
  <p>You can read the books and download the PDF versions for free. If you value my work and want to support me you can buy the PDF paying what you want. Thanks!</p>
  <article class="card">
    <a href="/pycabook-introduction/">
      <img src="/images/pycabook/card.jpg" alt="pycabook/card" />
    </a>
    <div class="body">
      <h2>Clean Architectures in Python</h2>
      <div class="actions">
        <a class="action" href="https://leanpub.com/clean-architectures-in-python">Buy the book</a>
      </div>
    </div>
  </article>

</section>
<section>
  <header>
    <h2>Get in touch</h2>
  </header>
  <ul class="contact">
    <li><i class="fab fa-twitter" aria-hidden="true"></i> <a href="https://twitter.com/thedigicat">Twitter</a></li>
  </ul>
</section>      </div>
      <div class="page">
	<header class="primary" >
	  <button type="button">
	    <i class="fas fa-bars"></i>
	  </button>
	  <p>The Digital Cat Books</p>
	</header>
	<div class="mobile-menu navigation">
<nav>
<div class="links">
  <ul>
    <li class="link"><a href="/index.html">Homepage</a></li>
    <li class="link"><a href="/pages/about.html">About</a></li>
  </ul>
</div></nav>
<section>
  <header>
    <h2>Categories</h2>
  </header>
<ul>
  <li><a href="/category/misc.html">misc</a></li>
</ul></section>
<section>
  <header>
    <h2>Tags</h2>
  </header>
<ul class="tags">
</ul></section>	</div>
	
<div class="page-content">
  <header>
    <p class="book-title">Clean Architectures in Python</p>
    <h1 class="section-title">Chapter 7 - Integration with a real external system - MongoDB</h1>
  </header>
  
  <div class="post-content">
    <blockquote><p>There's, uh, another example.</p><cite>Jurassic Park, 1993</cite></blockquote><p>The previous chapter showed how to integrate a real external system with the core of the clean architecture. Unfortunately I also had to introduce a lot of code to manage the integration tests and to globally move forward to a proper setup. In this chapter I will leverage the work we just did to show only the part strictly connected with the external system. Swapping the database from PostgreSQL to MongoDB is the perfect way to show how flexible the clean architecture is, and how easy it is to introduce different approaches like a non-relational database instead of a relational one.</p><h2 id="fixtures">Fixtures<a class="headerlink" href="#fixtures" title="Permanent link">¶</a></h2><p>Thanks to the flexibility of clean architecture, providing support for multiple storage systems is a breeze. In this section, I will implement the class <code>MongoRepo</code> that provides an interface towards MongoDB, a well-known NoSQL database. We will follow the same testing strategy we used for PostgreSQL, with a Docker container that runs the database and docker-compose that orchestrates the whole system.</p><p>You will appreciate the benefits of the complex testing structure that I created in the previous chapter. That structure allows me to reuse some of the fixtures now that I want to implement tests for a new storage system.</p><p>Let's start defining the file <code>tests/repository/mongodb/conftest.py</code>, which will contains pytest fixtures for MongoDB, mirroring the file we created for PostgreSQL</p><div class="code code-python"><div class="title"><code>tests/repository/mongodb/conftest.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymongo</span>
<span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;session&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mg_database_empty</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_HOSTNAME&quot;</span><span class="p">],</span>
        <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_PORT&quot;</span><span class="p">]),</span>
        <span class="n">username</span><span class="o">=</span><span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_USER&quot;</span><span class="p">],</span>
        <span class="n">password</span><span class="o">=</span><span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_PASSWORD&quot;</span><span class="p">],</span>
        <span class="n">authSource</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">]]</span>

    <span class="k">yield</span> <span class="n">db</span>

    <span class="n">client</span><span class="o">.</span><span class="n">drop_database</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">[</span><span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">])</span>
    <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mg_test_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;f853578c-fc0f-4e65-81b8-566c5dffa35a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">215</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">39</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.09998975</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.75436293</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">405</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.18228006</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.74640997</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">56</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.27891577</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.45994069</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;code&quot;</span><span class="p">:</span> <span class="s2">&quot;eed76e77-55c1-41ce-985d-ca49bf6c0585&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">93</span><span class="p">,</span>
            <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">0.33894476</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">51.39916678</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">]</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mg_database</span><span class="p">(</span><span class="n">mg_database_empty</span><span class="p">,</span> <span class="n">mg_test_data</span><span class="p">):</span>
    <span class="n">collection</span> <span class="o">=</span> <span class="n">mg_database_empty</span><span class="o">.</span><span class="n">rooms</span>

    <span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">mg_test_data</span><span class="p">)</span>

    <span class="k">yield</span> <span class="n">mg_database_empty</span>

    <span class="n">collection</span><span class="o">.</span><span class="n">delete_many</span><span class="p">({})</span>
</pre></div>
</div></div><p>As you can see these functions are very similar to the ones that we defined for Postgres. The function <code>mg_database_empty</code> is tasked to create the MongoDB client and the empty database, and to dispose them after the <code>yield</code>. The fixture <code>mg_test_data</code> provides the same data provided by <code>pg_test_data</code> and <code>mg_database</code> fills the empty database with it. While the SQLAlchemy package works through a session, PyMongo library creates a client and uses it directly, but the overall structure is the same.</p><p>Since we are importing the PyMongo library we need to change the production requirements</p><div class="code code-text"><div class="title"><code>requirements/prod.txt</code></div><div class="content"><div class="highlight"><pre><span></span>Flask
SQLAlchemy
psycopg2
pymongo
</pre></div>
</div></div><p>and run <code>pip install -r requirements/dev.txt</code>.</p><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c07-s01">https://github.com/pycabook/rentomatic/tree/ed2-c07-s01</a></p></div></div></div><h2 id="docker-compose-configuration">Docker Compose configuration<a class="headerlink" href="#docker-compose-configuration" title="Permanent link">¶</a></h2><p>We need to add an ephemeral MongoDB container to the testing Docker Compose configuration. The MongoDB image needs only the variables <code>MONGO_INITDB_ROOT_USERNAME</code> and <code>MONGO_INITDB_ROOT_PASSWORD</code> as it doesn't create any initial database. As we did for the PostgreSQL container we assign a specific port that will be different from the standard one, to allow tests to be executed while other containers are running.</p><div class="code code-yaml"><div class="title"><code>docker/testing.yml</code></div><div class="content"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
  <span class="nt">postgres</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">postgres</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">POSTGRES_DB</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_DB}</span>
      <span class="nt">POSTGRES_USER</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_USER}</span>
      <span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${POSTGRES_PASSWORD}</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;${POSTGRES_PORT}:5432&quot;</span>
  <span class="nt">mongo</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mongo</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">MONGO_INITDB_ROOT_USERNAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${MONGODB_USER}</span>
      <span class="nt">MONGO_INITDB_ROOT_PASSWORD</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">${MONGODB_PASSWORD}</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;${MONGODB_PORT}:27017&quot;</span>
</pre></div>
</div></div><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c07-s02">https://github.com/pycabook/rentomatic/tree/ed2-c07-s02</a></p></div></div></div><h2 id="application-configuration">Application configuration<a class="headerlink" href="#application-configuration" title="Permanent link">¶</a></h2><p>Docker Compose, the testing framework, and the application itself are configured through a single JSON file, that we need to update with the actual values we want to use for MongoDB</p><div class="code code-json"><div class="title"><code>config/testing.json</code></div><div class="content"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_ENV&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;production&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;FLASK_CONFIG&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;testing&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_USER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_HOSTNAME&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PORT&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;5433&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;POSTGRES_PASSWORD&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;postgres&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MONGODB_USER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MONGODB_HOSTNAME&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;localhost&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MONGODB_PORT&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;27018&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;MONGODB_PASSWORD&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;mongodb&quot;</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">,</span>
    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div></div><p>Since the standard port from MongoDB is 27017 I chose 27018 for the tests. Remember that this is just an example, however. In a real scenario we might have multiple environments and also multiple setups for our testing, and in that case we might want to assign a random port to the container and use Python to extract the value and pass it to the application.</p><p>Please also note that I chose to use the same variable <code>APPLICATION_DB</code> for the name of the PostgreSQL and MongoDB databases. Again, this is a simple example, and your mileage my vary in more complex scenarios.</p><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c07-s03">https://github.com/pycabook/rentomatic/tree/ed2-c07-s03</a></p></div></div></div><h2 id="integration-tests">Integration tests<a class="headerlink" href="#integration-tests" title="Permanent link">¶</a></h2><p>The integration tests are a mirror of the ones we wrote for Postgres, as we are covering the same use case. If you use multiple databases in the same system you probably want to serve different use cases, so in a real case this might probably be a more complicated step. It is completely reasonable, however, that you might want to simply provide support for multiple databases that your client can choose to plug into the system, and in that case you will do exactly what I did here, copying and adjusting the same test battery.</p><div class="code code-python"><div class="title"><code>tests/repository/mongodb/test_mongorepo.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">rentomatic.repository</span> <span class="kn">import</span> <span class="n">mongorepo</span>

<span class="n">pytestmark</span> <span class="o">=</span> <span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">integration</span>


<span class="k">def</span> <span class="nf">test_repository_list_without_parameters</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">mg_database</span><span class="p">,</span> <span class="n">mg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mongorepo</span><span class="o">.</span><span class="n">MongoRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>

    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">repo_rooms</span><span class="p">])</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span>
        <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">mg_test_data</span><span class="p">]</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_code_equal_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">mg_database</span><span class="p">,</span> <span class="n">mg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mongorepo</span><span class="o">.</span><span class="n">MongoRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span>
        <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;code__eq&quot;</span><span class="p">:</span> <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">repo_rooms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_equal_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">mg_database</span><span class="p">,</span> <span class="n">mg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mongorepo</span><span class="o">.</span><span class="n">MongoRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__eq&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">repo_rooms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_less_than_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">mg_database</span><span class="p">,</span> <span class="n">mg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mongorepo</span><span class="o">.</span><span class="n">MongoRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__lt&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">repo_rooms</span><span class="p">])</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;f853578c-fc0f-4e65-81b8-566c5dffa35a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eed76e77-55c1-41ce-985d-ca49bf6c0585&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_greater_than_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">mg_database</span><span class="p">,</span> <span class="n">mg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mongorepo</span><span class="o">.</span><span class="n">MongoRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__gt&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">repo_rooms</span><span class="p">])</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fe2c3195-aeff-487a-a08f-e0bdc0ec6e9a&quot;</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_between_filter</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">mg_database</span><span class="p">,</span> <span class="n">mg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mongorepo</span><span class="o">.</span><span class="n">MongoRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__lt&quot;</span><span class="p">:</span> <span class="mi">66</span><span class="p">,</span> <span class="s2">&quot;price__gt&quot;</span><span class="p">:</span> <span class="mi">48</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">repo_rooms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="s2">&quot;913694c6-435a-4366-ba0d-da5334a611b2&quot;</span>


<span class="k">def</span> <span class="nf">test_repository_list_with_price_as_string</span><span class="p">(</span>
    <span class="n">app_configuration</span><span class="p">,</span> <span class="n">mg_database</span><span class="p">,</span> <span class="n">mg_test_data</span>
<span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mongorepo</span><span class="o">.</span><span class="n">MongoRepo</span><span class="p">(</span><span class="n">app_configuration</span><span class="p">)</span>

    <span class="n">repo_rooms</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;price__lt&quot;</span><span class="p">:</span> <span class="s2">&quot;60&quot;</span><span class="p">})</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">repo_rooms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">repo_rooms</span><span class="p">])</span> <span class="o">==</span> <span class="p">{</span>
        <span class="s2">&quot;f853578c-fc0f-4e65-81b8-566c5dffa35a&quot;</span><span class="p">,</span>
        <span class="s2">&quot;eed76e77-55c1-41ce-985d-ca49bf6c0585&quot;</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div></div><p>I added a test called <code>test_repository_list_with_price_as_string</code> that checks what happens when the price in the filter is expressed as a string. Experimenting with the MongoDB shell I found that in this case the query wasn't working, so I included the test to be sure the implementation didn't forget to manage this condition.</p><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c07-s04">https://github.com/pycabook/rentomatic/tree/ed2-c07-s04</a></p></div></div></div><h2 id="the-mongodb-repository">The MongoDB repository<a class="headerlink" href="#the-mongodb-repository" title="Permanent link">¶</a></h2><p>The <code>MongoRepo</code> class is obviously not the same as the Postgres interface, as the PyMongo library is different from SQLAlchemy, and the structure of a NoSQL database differs from the one of a relational one. The file <code>rentomatic/repository/mongorepo.py</code> is</p><div class="code code-python"><div class="title"><code>rentomatic/repository/mongorepo.py</code></div><div class="content"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pymongo</span>

<span class="kn">from</span> <span class="nn">rentomatic.domain</span> <span class="kn">import</span> <span class="n">room</span>


<span class="k">class</span> <span class="nc">MongoRepo</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configuration</span><span class="p">):</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">pymongo</span><span class="o">.</span><span class="n">MongoClient</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_HOSTNAME&quot;</span><span class="p">],</span>
            <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_PORT&quot;</span><span class="p">]),</span>
            <span class="n">username</span><span class="o">=</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_USER&quot;</span><span class="p">],</span>
            <span class="n">password</span><span class="o">=</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;MONGODB_PASSWORD&quot;</span><span class="p">],</span>
            <span class="n">authSource</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="n">configuration</span><span class="p">[</span><span class="s2">&quot;APPLICATION_DB&quot;</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_create_room_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">room</span><span class="o">.</span><span class="n">Room</span><span class="p">(</span>
                <span class="n">code</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">],</span>
                <span class="n">size</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">],</span>
                <span class="n">price</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="s2">&quot;price&quot;</span><span class="p">],</span>
                <span class="n">latitude</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">],</span>
                <span class="n">longitude</span><span class="o">=</span><span class="n">q</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">results</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">rooms</span>

        <span class="k">if</span> <span class="n">filters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mongo_filter</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">filters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">operator</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;__&quot;</span><span class="p">)</span>

                <span class="n">filter_value</span> <span class="o">=</span> <span class="n">mongo_filter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">{})</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;price&quot;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="n">filter_value</span><span class="p">[</span><span class="s2">&quot;$</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">operator</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">mongo_filter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">filter_value</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">mongo_filter</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_room_objects</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div></div><p>which makes use of the similarity between the filters of the Rent-o-matic project and the ones of the MongoDB systemfootnote:[The similitude between the two systems is not accidental, as I was studying MongoDB at the time I wrote the first article about clean architectures, so I was obviously influenced by it.].</p><div class="admonition note"><i class="fa fa-github"></i><div class="content"><div class="title">Source code</div><div><p><a href="https://github.com/pycabook/rentomatic/tree/ed2-c07-s05">https://github.com/pycabook/rentomatic/tree/ed2-c07-s05</a></p></div></div></div><hr><p>I think this very brief chapter clearly showed the merits of a layered approach and of a proper testing setup. So far we implemented and tested an interface towards two very different databases like PostgreSQL and MongoDB, but both interfaces are usable by the same use case, which ultimately means the same API endpoint.</p><p>While we properly tested the integration with these external systems, we still don't have a way to run the whole system in what we call a production-ready environment, that is in a way that can be exposed to external users. In the next chapter I will show you how we can leverage the same setup we used for the tests to run Flask, PostgreSQL, and the use case we created in a way that can be used in production.</p><div id="_footnotes"></div>
  </div>

  <footer>
    <div class="prevnext">
      <div class="prevnext-prev">
	<p class="prevnext-label">Previous</p>
	<p>
	  <a href="/pycabook-chapter-06/">Chapter 6 - Integration with a real external system - Postgres</a>
	</p>
      </div>

      <div class="prevnext-next">
	<p class="prevnext-label">Next</p>
	<p>
	  <a href="/pycabook-chapter-08/">Chapter 8 - Run a production-ready system</a>
	</p>
      </div>
    </div>

    <div class="post-info">
      <p>Last update: <time datetime="2021-08-20T16:00:00+01:00"> 20/08/2021</time></p>
      <p class="tags">
      </p>
      <p class="share">Share on: <span><a class="" href="https://twitter.com/intent/tweet?text=Chapter%207%20-%20Integration%20with%20a%20real%20external%20system%20-%20MongoDB&url=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-07/&via=thedigicat" target="_blank" title="Share on Twitter"><i class="fab fa-twitter"></i> Twitter</a></span>
<span><a class="" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-07/&title=Chapter%207%20-%20Integration%20with%20a%20real%20external%20system%20-%20MongoDB&summary=&source=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-07/" target="_blank" title="Share on LinkedIn"><i class="fab fa-linkedin"></i> LinkedIn</a></span>
<span><a class="" href="https://news.ycombinator.com/submitlink?t=Chapter%207%20-%20Integration%20with%20a%20real%20external%20system%20-%20MongoDB&u=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-07/" target="_blank" title="Share on HackerNews"><i class="fab fa-hacker-news"></i> HackerNews</a></span>
<span><a class="" href="mailto:?subject=Chapter%207%20-%20Integration%20with%20a%20real%20external%20system%20-%20MongoDB&amp;body=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-07/" target="_blank" title="Share via Email"><i class="fas fa-envelope"></i> Email</a></span>
<span><a class="" href="https://www.reddit.com/submit?url=https%3A//www.thedigitalcatbooks.com/pycabook-chapter-07/&title=Chapter%207%20-%20Integration%20with%20a%20real%20external%20system%20-%20MongoDB" target="_blank" title="Share via Reddit"><i class="fab fa-reddit"></i> Reddit</a></span></p>    
    </div>
  </footer>
  
  <section class="links">
    <header>
      <h2>Section 9 of Clean Architectures in Python</h2>
    </header>
    <div>
      <h3>Previous</h3>
      <ul>
        <li><a href="/pycabook-introduction/">Introduction</a></li>
        <li><a href="/pycabook-about-the-book/">About the book</a></li>
        <li><a href="/pycabook-chapter-01/">Chapter 1 - A day in the life of a clean system</a></li>
        <li><a href="/pycabook-chapter-02/">Chapter 2 - Components of a clean architecture</a></li>
        <li><a href="/pycabook-chapter-03/">Chapter 3 - A basic example</a></li>
        <li><a href="/pycabook-chapter-04/">Chapter 4 - Add a web application</a></li>
        <li><a href="/pycabook-chapter-05/">Chapter 5 - Error management</a></li>
        <li><a href="/pycabook-chapter-06/">Chapter 6 - Integration with a real external system - Postgres</a></li>
      </ul>
      
      <h3>Next</h3>
      <ul>
        <li><a href="/pycabook-chapter-08/">Chapter 8 - Run a production-ready system</a></li>
        <li><a href="/pycabook-changelog/">Changelog</a></li>
        <li><a href="/pycabook-colophon/">Colophon</a></li>
      </ul>
    </div>
  </section>

  
</div>

      </div>
    </div>
    <script src="/theme/js/packed.js?46a8f903"></script>

  </body>
</html>